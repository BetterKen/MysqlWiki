# 6 Mysql索引介绍

【注意】主要介绍Innodb的索引结构

## 6.1 Innodb索引组织表

和MyISAM的一个大区别,在Innodb的存储引擎中,表都是根据`主键`顺序组织存放的.我们把这种存储方式的表成为`索引组织表(index origanized table)`即大家常说的`IOT`方式

Innodb规定每一个表必须需要有主键(PK),主键的选择方式按照如下顺序选择:

1. 如有有定义主键 则选择此主键
2. 如果为定义主键 选择`第一个定义的非空唯一索引`做主键:这里注意有三个条件:`非空`,`唯一`,`第一个满足以上两个条件的索引`
3. 如果以上两个都没有,Innodb会自动创建一个6字节大小的指针:隐式的创建,平时查询不能看到

```mysql
我们可以通过以下语句查看每一行的主键id,
select *,_rowid form table;

_rowid表示表的主键 
需要注意的是 _rowid只能用于查看单个列为主键的情况 对于多列组成的主键就不好使了
```

## 6.1 Innodb逻辑存储结构

之间介绍过Innodb库表的文件结构为两个:

```
${tablename}.frm   #表结构文件
${tablename}.idb   #表索引及数据文件
```
所有的数据都被逻辑的存放在一个空间中(.idb文件中),我们称这个空间为`表空间(tablespace)`

表空间的组成结构如下图所示:

![](http://mysql317.oss-cn-beijing.aliyuncs.com/innodb_engine_struct.png)

这样看可能不明显 再看一个:

![](http://mysql317.oss-cn-beijing.aliyuncs.com/tablespace.png)



```
可以看到:
表空间
  ↓
段segment
  ↓
区extent
  ↓
页page/块block   <---最小储存单元

而页里面包含了一个一个的行数据
  
```

### 6.2.1 表空间

在5.6以前所有的数据都存在共享表空间ibdata1中，在5.6以后加入了`innodb_file_per_table`参数默认是开启的,建议也是开启的,开启了这个参数后,每张表内的数据会单独放到一个表空间内

需要注意的是:每张表空间内存放的只有:

- 数据
- 索引
- 插入缓存Bitmap

其他的一些信息如:undo操作,插入缓存索引页,失误信息,double write buffer还是存在ibdata里

ibdata的具体介绍会在innodb索引章节进行介绍说明

### 6.2.2 段

常见的段分类如下:

- 数据段
- 索引段
- 回滚段

### 6.2.3 区 

区是由`连续的页`组成的空间,`在任何情况下每个区的大小都为1MB`

为了保证区的连续性,每次存储引擎都会从磁盘申请四五个区

默认情况下,Innodb页的大小为16KB,即一个区共有64个页  => (2^10) / (2^4)

页的大小可以在初始化的时候进行调整,但是区的大小总为1MB

### 6.2.4 页

页是InnoDB存储引擎磁盘管理的最小单位，每个页默认16KB

可以通过参数`innodb_page_size`将页的大小设置为4K、8K、16K

若设置完成，则所有表中页的大小都为innodb_page_size，不可以再次对其进行修改

除非通过mysqldump导入和导出操作来产生新的库

innodb的所有数据文件（后缀为ibd的文件），他的大小始终都是`innodb_page_size` (16384(16k))的整数倍

```
[root@centos7-1 baseinfo]# ll|grep 'ibd' 
-rw-r-----. 1 mysql mysql 2663383040 xxx.ibd  => 2663383040 = 16384*162560
-rw-r-----. 1 mysql mysql  868220928 ccc.ibd  => 868220928 = 16384*52992
```



`innodb_page_size`的大小限制了tablespace表空间的大小:

Table 14.25 InnoDB Maximum Tablespace Size

| InnoDB Page Size | Maximum Tablespace Size |
| ---------------- | ----------------------- |
|4KB|16TB|
|8KB|32TB|
|16KB|64TB|
|32KB|128TB|
|64KB|256TB|

### 6.2.5 行

Innodb存储引擎是面向列的,也就是数据是按行存放的,每个页存放行的记录也是有硬性规定的

最多允许存放16KB/2-200行记录,即7992行

但实际上互联网公司一行的数据大概为1KB,即一个page可以存放16行数据

## 6.3 B+树结构

无论是MyISAM还是Innodb 他们在存储数据时,都用到了B+树结构

### 6.3.1 B+树结构

(1) 原理图:

![](http://mysql317.oss-cn-beijing.aliyuncs.com/BTree.png)

(2)特点：

- 非叶子节点只存储键值信息
- 所有叶子节点之间都有一个链指针
- 叶子节点也多存储了指向下一个叶子节点的指针，更方便叶子节点的范围遍历
- 数据记录都存放在叶子节点中
- 所有的叶子节点组成一个循环双向链表

### 6.3.2 MyISAM实现B+Tree

(1)原理图：

![](http://mysql317.oss-cn-beijing.aliyuncs.com/MtISAMBTree.png)

(2)特点：

- 索引文件和数据文件是分离的
- 索引文件仅保存数据行记录的地址（行指针）
- 主索引与二级索引无区别
- 二级索引也存储的是行指针

### 6.3.3 Innodb实现B+Tree

(1)原理图：

![](http://mysql317.oss-cn-beijing.aliyuncs.com/InnodbBtree.png)

(2)特点：

- 主键索引既存储索引值，又在叶子节点中存储整行的数据
- 二级索引存储索引列值+主键信息
- 必须有主键 主键的选择如前文所释

## 6.4 索引分类

我们根据索引文件是否和数据文件共同存储,可讲索引分为:

- 聚簇索引(聚集索引)
- 非聚簇索引(辅助索引)

不管是聚簇索引还是非聚簇索引我们看到他们内部都是B+树的,即高度平衡的,他们之间的区别是叶子节点是否存放的是一整行数据信息



### 6.4.1 聚簇索引

由于实际的数据也





## 6.4 索引作用

## 6.5 索引种类和算法

## 6.6 索引创建

