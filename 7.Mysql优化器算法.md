# 7 Mysql优化器算法

除了我们自己手动进行优化外,根据之前的章节,我们可以知道,Mysql内部自己有优化器,对SQL语句进行一些内部的优化,本章介绍几个常用的优化算法:

- MRR
- ICP
- BKA

## 7.1 MRR

MRR——Multi Range Read

### 7.1.1目的

减少磁盘的随机访问，并将随机访问转化为顺序的数据访问

### 7.1.2 原理

在不使用 MRR 时，优化器需要根据二级索引返回的记录来进行“回表”，这个过程一般会有较多的随机 IO, 使用 MRR 时，SQL 语句的执行过程是这样的：

1. 优化器将二级索引查询到的记录放到一块缓冲区中；
2. 如果二级索引扫描到文件的末尾或者缓冲区已满，则使用`快速排序对缓冲区中的内容按照主键进行排序`；
3. 用户线程调用 MRR 接口取 cluster index，然后根据cluster index 取行数据；
4. 当根据缓冲区中的 cluster index 取完数据，则继续调用过程 2) 3)，直至扫描结束；

通过上述过程，优化器将二级索引随机的 IO 进行排序，转化为主键的有序排列，从而实现了随机 IO 到顺序 IO 的转化，提升性能



在未开启MRR时,查询方式如图所示:

![](http://mysql317.oss-cn-beijing.aliyuncs.com/no-mrr-access-pattern.png)



开启MRR后,查询方式如下图所示:

![](http://mysql317.oss-cn-beijing.aliyuncs.com/mrr-access-pattern.png)



### 7.1.3 开关MRR

我们可以通过 以下命令查看和开启MRR,5.6以后默认是开启的

```mysql
查看MRR是否开启
mysql> select @@optimizer_switch\G
*************************** 1. row ***************************
@@optimizer_switch: index_merge=on,index_merge_union=on,index_merge_sort_union=on,index_merge_intersection=on,engine_condition_pushdown=on,index_condition_pushdown=on,mrr=on,mrr_cost_based=on,block_nested_loop=on,batched_key_access=off,materialization=on,semijoin=on,loosescan=on,firstmatch=on,duplicateweedout=on,subquery_materialization_cost_based=on,use_index_extensions=on,condition_fanout_filter=on,derived_merge=on
1 row in set (0.00 sec)

注意上面的mrr=on

关闭MRR
mysql> set optimizer_switch='mrr=off';
开启MRR
mysql> set optimizer_switch='mrr=on';

相关参数
当mrr=on,mrr_cost_based=on，则表示cost base的方式还选择启用MRR优化,当发现优化后的代价过高时就会不使用该项优化
当mrr=on,mrr_cost_based=off，则表示总是开启MRR优化

尽量设置 mrr_cost_based=ON，毕竟大多数情况下优化器是对的

```

### 7.1.4 开关对比

```mysql
mysql> explain select *  from t_scrm_user_info where bigdata_user_id > 'A1001036' and bigdata_user_id < 'A2100000';
```

当`mrr=off`时

![](http://mysql317.oss-cn-beijing.aliyuncs.com/mrroffexplain.png)

当`mrr=on`时

![](http://mysql317.oss-cn-beijing.aliyuncs.com/mrrontime.png)

可以看到当mrr开启时, extra 的输出中多了 “Using MRR” 信息，即使用了 MRR Optimization IO 层面进行了优化，减少 IO 方面的开销

在时间上理论上可以查一个数量级,但是要在缓存池中没有预热以及查询的数据不在缓冲池中才可以

我测试的时候时间都差不多 (⊙﹏⊙)b













